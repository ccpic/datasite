<div class="ui container">
    <div class="ui form">
        <form action="" method="post">
            <!-- 在Django所有的 POST 表单元素时，需要加上下方的csrf_token tag，主要是安全方面的机制 -->
            {% csrf_token %}
            <h3 class="ui header" id="analysis">分析维度</h3>
            <div class="field">
                <select name="DIMENSION_select" id="DIMENSION_select" class="ui fluid tiny search dropdown">
                    {% for key, value in mselect_dict.items %}
                    <option value="{{ value.select }}">{{ key }}</option>
                    {% endfor %}
                </select>
            </div>
            <h3 class="ui header" id="data_filter">
                数据筛选
                {#                <div class="content">#}
                {#                    <div class="ui pointing below red basic label">#}
                {#                        请选择销售数据筛选的范围#}
                {#                    </div>#}
                {#                </div>#}
            </h3>
            <div class="field">
                {% for key, value in mselect_dict.items %}
                <div class="field">
                    <select name="{{ value.select|add:"_select[]" }}" id="{{ value.select|add:"_select" }}" multiple=""
                        class="ui fluid tiny search dropdown">
                        <option value="">{{ key }}</option>
                        {% for item in value.options %}
                        <option value="{{ item }}">{{ item }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
            <br>
            <div class="ui fluid buttons">
                <!--<input class="ui button" type="reset" id="reset"/>-->
                <!--<div class="or"></div>-->
                <input class="ui blue button" type='button' id='AJAX_get' value="查询" />
                <input class="ui blue basic button" type='button' id='show_options' value="选项" />
            </div>
        </form>
    </div>
</div>


<script>
    function submitForm() {
        //获取form表单对象
        var form = document.getElementById("myform");
        form.submit(); //form表单提交
    }
</script>

<!-- 因为用到Semantic UI的Search Dropdown控件，必须有下面语句初始化 -->
<script>
    $('.ui.fluid.search.dropdown')
        .dropdown({
            fullTextSearch: true
        });
</script>
<script>
    $("#show_options").click(function () {
        $("#modal_options").modal({
                closable: false,
                onApprove: function () {
                    $("#modal_options").modal('hide')
                }
            })
            .modal('show')
    })
</script>
{#<script>#}
{#    // 在JS中再次使用字段字典#}
{#    var dict = {{ mselect_dict|safe }};#}
{#    // 在Django模板中遇到带有{}的字符串必须使用replace这种方式#}
{#    var url = "{% url 'internal_sales:search' 'COLUMNPLACEHOLDER' 'QUERYPLACEHOLDER' %}".replace(#}
{#        'QUERYPLACEHOLDER', '{query}'#}
{#    );#}
{#    // jQuery语法遍历所有多选框#}
{#    $('.ui.fluid.search.dropdown.selection.multiple').each(function () {#}
{#        // Semantic UI语法获得多选框默认文本#}
{#        var text = $(this).dropdown('get default text');#}
{#        // 上方语句如遇到bug可不使用Semantic UI API，直接用Jquery语句#}
{#        var text = $(this).children('select').children('option:first').text();#}
{#        // 根据字典倒推该多选框是哪个字段#}
{#        var column = dict[text]['select'];#}
{#        $(this).dropdown(#}
{#            {#}
{#                apiSettings: {#}
{#                    // 用下方URL从后端返回查询后的json#}
{#                    url: url.replace('COLUMNPLACEHOLDER', column)#}
{#                },#}
{#                // 输入至少2个字符后才query#}
{#                minCharacters: 2,#}
{#                cache: false#}
{#            })#}
{#        ;#}
{#    })#}
{#</script>#}
<script type="text/javascript">
    $("#AJAX_get").click(function (event) {
        event.preventDefault(); // 防止表单默认的提交
        var dimmer_dummy = $("#dimmer_dummy"); // 使用一个透明dummy dimmer保证loading文字一直显示在viewport中央
        $("#dimmer").attr('class', 'ui active dimmer');
        dimmer_dummy.attr('class', 'ui active dimmer'); // 非透明的dimmer依旧负责遮罩功能，点击筛选按钮后dimmer变成active
        dimmer_dummy.children('div').remove(); // 删除初始化文字
        dimmer_dummy.append('<div class="ui text loader">数据加载中……</div>'); // 增加loading效果和文字

        // Pyecharts图表初始化

        // 获取交互表单数据
        var form_data = getForm();

        // 根据参数生成服务器端dt表格
        var url_table_hp = '{% url 'potential:table_hp' %}';
        var columns_table_hp = [{
                title: "医院编码",
                data: "hp_id"
            },
            {
                title: "医院名称",
                data: "hp_name"
            },
            {
                title: "省份",
                data: "province"
            },
            {
                title: "城市",
                data: "city"
            },
            {
                title: "区县",
                data: "county"
            },
            {
                title: "地区经理",
                data: "am"
            },
            {
                title: "负责代表",
                data: "rsp"
            },
            {
                title: "医院类型",
                data: "hp_type"
            },
            {
                title: "等级/社区医院内部潜力分级",
                data: "decile"
            },
            {
                title: "所有终端合并计算潜力分级",
                data: "decile_total"
            },
            {
                title: "潜力值(DOT)",
                data: "potential_dot"
            },
            {
                title: "信立坦MAT销售(DOT)",
                data: "mat_sales"
            },
            {
                title: "信立坦份额(%)",
                data: "share"
            },
        ];
        var columnDefs_table_hp = [{
                "width": "5%",
                "targets": [8, 9, 12]
            }, // 保持表格相对列宽度固定
            {
                "width": "10%",
                "targets": [0, 5, 7, 10, 11]
            }, // 保持表格相对列宽度固定
            {
                "targets": [12],
                "render": $.fn.dataTable.render.percentBar('square', '#000', '#BCBCBC', '#00bfff',
                    '#E6E6E6', 1, 'ridge')
            }, // 根据一定的色彩方案初始化条形图
        ];

        // 终端明细表格太大，采用Ajax服务器端更新数据的方法，因此单独与后端通信
        $("#table_hp").DataTable(
            initAjaxDataTable(url_table_hp, columns_table_hp, form_data, 10, columnDefs_table_hp)
        )

        var columnDefs_table_pivot = [{
                type: 'percent',
                targets: [3, 5, 7, 9, 10, 11, 12]
            },
            {
                targets: [3],
                render: $.fn.dataTable.render.percentBar('square', '#000', '#BCBCBC', '#00bfff', '#E6E6E6',
                    1, 'ridge') // 根据一定的色彩方案初始化条形图
            },
            {
                targets: [5, 7],
                render: $.fn.dataTable.render.percentBar('square', '#000', '#BCBCBC', '#FFD700', '#E6E6E6',
                    1, 'ridge') // 根据一定的色彩方案初始化条形图
            },
            {
                targets: [9],
                render: $.fn.dataTable.render.percentBar('square', '#000', '#BCBCBC', '#CAB1F5', '#E6E6E6',
                    1, 'ridge') // 根据一定的色彩方案初始化条形图
            },
            {
                targets: [10, 11, 12],
                render: $.fn.dataTable.render.percentBar('square', '#000', '#BCBCBC', '#FFABD1', '#E6E6E6',
                    1, 'ridge') // 根据一定的色彩方案初始化条形图
            },
        ];

        $.ajax({
            // 请求的url
            url: '{% url 'potential:query' %}',
            // 请求的type
            type: 'GET',
            // 发送的数据
            data: form_data,
            // 回调函数，其中ret是返回的JSON，可以以字典的方式调用
            success: function (ret) { //成功执行
                // 去除加载遮罩（去掉active）
                dimmer_dummy.attr('class', 'ui dimmer');
                $("#dimmer").attr('class', 'ui dimmer');

                // 总体指标
                var kpi = ret["kpi"]
                $("#potential_total").html(kpi["潜力(DOT)"].toLocaleString())
                $("#number_total").html(kpi["终端数量"].toLocaleString())
                $("#share_total").html(toPercent(kpi["信立坦所有终端份额(DOT %)"]))
                $("#potential_target").html(toPercent(kpi["信立坦目标终端覆盖潜力(DOT %)"]))
                $("#number_target").html(kpi["信立坦目标终端数"].toLocaleString())
                $("#share_target").html(toPercent(kpi["信立坦目标终端份额(DOT %)"]))
                $("#potential_sales").html(toPercent(kpi["信立坦有量终端覆盖潜力(DOT %)"]))
                $("#number_sales").html(kpi["信立坦有量终端数"].toLocaleString())
                $("#share_sales").html(toPercent(kpi["信立坦有量终端份额(DOT %)"]))

                // 展示datatables表格
                $("#table_pivot_div").html(ret['table_pivot']);
                initTable($("#table_pivot"), 2, columnDefs_table_pivot);
                // 展示Matplotlib气泡图
                $("#plot_bubble_contrib").attr('src', ret['plot_bubble_contrib']);
                $("#plot_bubble_contrib2").attr('src', ret['plot_bubble_contrib2']);
                $("#plot_bubble_allocation").attr('src', ret['plot_bubble_allocation']);
            },
            error: function () { //失败
                console.log('失败');
                dimmer_dummy.children('div').text('有错误发生，无法完成查询'); // AJAX回调失败则报错
            }
        });
    })
</script>

<script>
    function toPercent(str) {
        if (isNaN(str) === false) {
            var strP = Number(str * 100).toFixed(1);
            strP += "%";
        } else {
            strP = str;
        }
        return strP;
    }
</script>
<script>
    function getForm() {
        // 获取单选下拉框的值
        var form_data = {
            "DIMENSION_select": $("#DIMENSION_select").val(),
        };

        // 获取多选下拉框的值
        var dict = {{ mselect_dict|safe }};
        for (key in dict) {
            var form_name = dict[key]['select'] + "_select";
            jquery_selector_id = "[id='" + form_name + "']"; //因为我们的部分多选框id有空格，要用这种写法
            form_data[form_name] = $(jquery_selector_id).val();
        }

        // 获取输出选项modal的值
        form_data['customized_sql'] = $('#customized_sql').val();

        return form_data
    }
</script>

<script>
    function initChart(chart_id) {
        var chart = echarts.init(document.getElementById(chart_id), 'white', {
            renderer: 'canvas'
        });
        chart.showLoading({
            text: '正在加载数据'
        }); //增加加载提示
        return chart
    }
</script>

<script>
    function updateChart(chart, chart_options) {
        chart.clear();
        if (chart_options !== "null") {
            chart.setOption(chart_options);
            chart.hideLoading();
        }
    }
</script>

<script type="text/javascript">
    $(document).ready(function () {
        $.ajaxSetup({
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }
        });
    });
</script>


<script>
    function initTable(table, orderBy, columnDefs) {
        table.DataTable({
            order: [
                [orderBy, "desc"]
            ], // 初始以第2列（注意第一列索引为0）由高到低排序
            pageLength: 25, // 前端分页，初始每页显示25条记录
            autoWidth: false, // 不自动调整表格宽度
            oLanguage: { // UI Label本地化
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sProcessing": "处理中...",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 条结果，共 _TOTAL_ 条",
                "sInfoEmpty": "没有数据",
                "sInfoFiltered": "(获取 _MAX_ 条客户档案)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "未查询到数据",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
            },
            "columnDefs": columnDefs,
        });
        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
            "percent-pre": function (a) {

                var x = (a == "+nan%" || a === 'nan%' || a === '-nan%' || a === 'inf%' || a === '+inf%' ||
                    a === '-inf%') ? 0 : a.replace(/%/, "");
                return parseFloat(x);
            },

            "percent-asc": function (a, b) {
                return ((a < b) ? -1 : ((a > b) ? 1 : 0));
            },

            "percent-desc": function (a, b) {
                return ((a < b) ? 1 : ((a > b) ? -1 : 0));
            }
        });
    }
</script>

<script>
    // Ajax table初始化方法
    function initAjaxDataTable(urlParam, columnsParam, form_data, orderBy, columnDefs) {
        return {
            order: [
                [orderBy, "desc"]
            ], // 初始以第2列（注意第一列索引为0）由高到低排序
            pageLength: 25, // 前端分页，初始每页显示25条记录
            destroy: true, //每次初始化前会先摧毁已经存在的表格对象
            sPaginationType: "full_numbers", //分页风格，full_number会把所有页码显示出来
            searching: true, //搜索
            ordering: true, //是否启用排序
            autoWidth: false, // 关闭自动调整表格宽度
            bProcessing: true, //是否显示加载
            sAjaxSource: urlParam, //请求资源路径
            serverSide: true, //开启服务器处理模式
            /*
                 使用ajax，在服务端处理数据
                 sSource:即是"sAjaxSource"
                 aoData:要传递到服务端的参数
                 fnCallback:处理返回数据的回调函数
            */
            fnServerData: function (sSource, aoData, fnCallback) {
                $.ajax({
                    'type': 'POST',
                    "url": sSource,
                    "dataType": "json",
                    "data": {
                        "aodata": JSON.stringify(aoData),
                        "formdata": JSON.stringify(form_data),
                    },
                    "success": function (resp) {
                        fnCallback(resp);
                    }
                });
            },
            "oLanguage": { //语言设置
                "sLengthMenu": '<select class="form-control" style="width:150px">' +
                    '<option value="10" selected>每页显示10条</option>' +
                    '<option value="25">每页显示25条</option>' +
                    '<option value="50">每页显示50条</option>' +
                    '<option value="100">每页显示100条</option>' +
                    '</select>',
                "sProcessing": "处理中...",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 条客户档案，共 _TOTAL_ 条",
                "sInfoEmpty": "没有数据",
                "sInfoFiltered": "(获取 _MAX_ 条客户档案)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
            },
            "columnDefs": columnDefs,
            "bServerSide": true, //开启服务器模式，使用服务器端处理配置datatable。
            "columns": columnsParam,
        }
    }
</script>