<!-- extends表明此页面继承自 base.html 文件 -->
{% extends "chpa_data/base.html" %} {% load humanize %} {% load tags %}
{% block title %}RDPAC数据平台{% endblock title %}

<!-- 隐藏分隔条 -->
<div class="ui hidden divider"></div>

<!-- 写入 base.html 中定义的 body content -->
{% block body %}

<div class="ui hidden divider"></div>

<div class="ui container">
  <div id="pusher" class="pusher" style="padding-top: 50px">
    <div class="ui inverted segment">
      <form  class="ui inverted fluid form">
        {% csrf_token %}
        <div class="field">
          <div class="ui fluid search">
              <input class="prompt" type="text"
                      placeholder="输入关键字同时搜索公司/药品">
              <div class="results"></div>
          </div>
        </div>
        {% comment %} 常用关键字：{% for link in hot_kws %}<a class="quick link">{{ link }}</a>; {% endfor %} {% endcomment %}
      </form>
    </div>
  </div>
  <div class="ui hidden divider"></div>
  <div class="ui grid">
    <div class="eight wide column">
      <table class="ui red table">
        <thead>
          <tr>
            <th>Rank</th>
            <th colspan="2">Company</th>
            <th>Country</th>
            <th>Sales</th>
            <th>Sales GR</th>
          </tr>
        </thead>
        <tbody>
          {% for company in companies_ranked %}
          <tr>
            <td>{{ forloop.counter0|add:1 }}</td>
            <td><img src="{{ company.logo.url }}" height="30" /></td>
            <td>
              <div class="item">
                <div class="middle aligned content">
                  <div class="header"><a href="{% url 'rdpac:company_detail' company.pk %}">{{ company.name_cn }}</a></div>
                  <div class="meta">
                    <span class="molecule_en">{{ company.name_en }}</span>
                  </div>
                </div>
              </div>
            </td>
            <td><i class="{{ company.country_code }} flag"></i></td>
            <td>
              {{ company.latest_annual_netsales|intword }}
            </td>
            <td class="gr">
              {% if company.latest_annual_netsales_gr %}
              {{ company.latest_annual_netsales_gr|percentage:0 }}
              {% else %}
              new
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="eight wide column">
      <table class="ui blue table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Drug</th>
            <th>Company</th>
            <th>Sales</th>
            <th>Sales GR</th>
          </tr>
        </thead>
        <tbody>
          {% for sales in sales_ranked %}
          <tr>
            <td>{{ forloop.counter0|add:1 }}</td>
            <td>
              <div class="item">
                <div class="middle aligned content">
                  <div class="header">
                    <a href="{% url 'rdpac:drug_detail' sales.drug.pk %}">{{ sales.drug.molecule_cn }}</a>
                  </div>
                  <div class="meta">
                    <span class="molecule_en">{{ sales.drug.molecule_en }}</span>
                  </div>
                </div>
              </div>
            </td>
            <td>
              <div class="item">
                <div class="middle aligned content">
                  <div class="header">{{ sales.company.name_cn }}</div>
                  <div class="meta">
                    <span class="molecule_en">{{ sales.company.name_en }}</span>
                  </div>
                </div>
              </div>
            </td>
            <td>
              {{ sales.drug.latest_annual_netsales|intword }}
            </td>
            <td class="gr">
              {% if sales.drug.latest_annual_netsales_gr %}
              {{ sales.drug.latest_annual_netsales_gr|percentage:0 }}
              {% else %}
              new
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<div class="ui hidden divider"></div>
<style>
  .quick.link {
    color: #e9e9e9;
    cursor: pointer;
  }

  .quick.link:hover {
    color: #0d71bb;
    cursor: pointer;
  }

  .green {
    color: green;
  }

  .red {
    color: red;
  }
</style>
<style>
.ui.search>.results .result .image {
    float: right;
    overflow: hidden;
    background: 0 0;
    width: auto;
    height: 3em;
    border-radius: .25em;
}
</style>
<script>
  $(document).ready(function () {
    $('.gr:contains("-")').css('color', 'red');
    $('.gr:not(:contains("-"))').css('color', 'green');
  });
</script>

<script>
  var url = "{% url 'rdpac:search' 'QUERYPLACEHOLDER' %}".replace(
      'QUERYPLACEHOLDER', '{query}'
  )
  $('.ui.fluid.search').search({
      type: 'category',
      apiSettings: {
          onResponse: function (searchResponse) {
              var
                  response = {
                      results: {}
                  }
              ;
              console.log(searchResponse)
              // translate API response to work with search
              $.each(JSON.parse(searchResponse.data), function (index, item) {
                  var
                      maxResults = 8
                      company_url = "{% url 'rdpac:company' %}";
                      drug_url = "{% url 'rdpac:drug' %}";
                  ;
                  if (index >= maxResults) {
                      return false;
                  }
                  // create new categories
                  if (response.results["企业"] === undefined) {
                      response.results["企业"] = {
                          name: "企业",
                          results: []
                      };
                  }
                  if (response.results["药品"] === undefined) {
                      response.results["药品"] = {
                          name: "药品",
                          results: []
                      };
                  }

                  // add result to categories
                  if (item.model === "rdpac.company") {
                    response.results["企业"].results.push({
                        title: item.fields.name_cn,
                        description: item.fields.name_en,
                        image: {{ MEDIA_URL }} + item.fields.logo,
                        url: company_url + item.pk,
                        pk: item.pk
                    });
                  }
                  else if (item.model === "rdpac.drug") {
                      response.results["药品"].results.push({
                        title: item.fields.product_name_cn + " " + item.fields.product_name_en,
                        description: item.fields.molecule_cn + " " + item.fields.molecule_en,
                        url: drug_url + item.pk,
                        pk: item.pk
                    });
                  }
              });
              return response;
          },
          url: url
      },
      onSelect: function (result,response) {
          var row = $("#client-selected tr:has(td:contains(" + result.pk +"))")
          row.each(function () {
                $(this).remove();
          });
          $('#client-selected tbody').append('<tr><td style="display:none">' + result.pk +
              '</td><td>' + result.hospital +
              '</td><td>' + result.dept +
              '</td><td>' +result.title +
              '</td><td class="collapsing"><button class="ui negative basic button"' + ' onclick="$(this).closest(\'tr\').remove();">删除</button>'+
              '</td></tr>');
          return true;
      }
  });
</script>

{% endblock body %}